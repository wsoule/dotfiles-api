<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates - Dotfiles Manager</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/universal-header.css">
</head>
<body>
    <!-- Universal Header -->
    <header class="universal-header">
        <div class="header-container">
            <a href="/" class="header-brand">
                Dotfiles Manager
            </a>
            <nav class="header-nav">
                <a href="/">Home</a>
                <a href="/templates" class="active">Templates</a>
                <a href="/docs">Documentation</a>
            </nav>
            <div class="header-attribution">
                <div class="auth-section" id="auth-section">
                    <div class="auth-loading" id="auth-loading">Loading...</div>
                    <div class="auth-logged-out" id="auth-logged-out" style="display: none;">
                        <a href="/auth/github" class="btn btn-primary btn-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Sign in with GitHub
                        </a>
                    </div>
                    <div class="auth-not-configured" id="auth-not-configured" style="display: none;">
                        <span class="auth-message">Authentication not configured</span>
                    </div>
                    <div class="auth-logged-in" id="auth-logged-in" style="display: none;">
                        <div class="user-menu">
                            <img id="user-avatar" class="user-avatar" src="" alt="">
                            <span id="user-name"></span>
                            <div class="user-dropdown">
                                <a href="#" id="user-profile-link">Profile</a>
                                <a href="#" onclick="showFavorites()">Favorites</a>
                                <a href="/auth/logout">Sign out</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="attribution-links">
                    <span>Created by Wyat Soule</span>
                    <a href="https://github.com/wsoule" target="_blank">GitHub</a>
                    <a href="https://github.com/wsoule/go-dotfiles" target="_blank">Repository</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Templates Header -->
        <div class="templates-header">
            <div class="hero-content">
                <div class="hero-badge">Development Templates</div>
                <h1 class="hero-title">
                    Template Library
                    <span class="hero-subtitle">Pre-built configurations for every development stack</span>
                </h1>
                <p class="hero-description">
                    Browse our curated collection of development environment templates. Each template includes carefully selected packages, configurations, and tools for specific workflows and technologies.
                </p>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats" id="template-stats">
            <div class="stat-card">
                <h3>Total Templates</h3>
                <div class="number" id="total-templates">-</div>
            </div>
            <div class="stat-card">
                <h3>Featured Templates</h3>
                <div class="number" id="featured-templates">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Downloads</h3>
                <div class="number" id="total-template-downloads">-</div>
            </div>
            <div class="stat-card">
                <h3>Categories</h3>
                <div class="number" id="template-categories">6</div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="templates-controls">
            <div class="search-box">
                <input type="text" id="template-search" placeholder="Search templates by name, description, or technology...">
            </div>

            <div class="filter-row">
                <div class="form-group">
                    <label for="template-tags">Filter by Tags</label>
                    <input type="text" id="template-tags" placeholder="web-dev, data-science, devops...">
                </div>
                <div class="form-group">
                    <label for="template-featured">Show</label>
                    <select id="template-featured">
                        <option value="">All Templates</option>
                        <option value="true">Featured Only</option>
                        <option value="false">Community Templates</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="template-sort">Sort By</label>
                    <select id="template-sort">
                        <option value="downloads">Most Downloaded</option>
                        <option value="name">Name A-Z</option>
                        <option value="updated">Recently Updated</option>
                        <option value="author">Author</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Template Categories -->
        <div class="template-categories">
            <h2>Popular Categories</h2>
            <div class="category-grid">
                <div class="category-card" onclick="filterByCategory('web-dev')">
                    <div class="category-icon">üåê</div>
                    <h3>Web Development</h3>
                    <p>Frontend, backend, and full-stack web development setups</p>
                    <div class="category-count" id="web-dev-count">-</div>
                </div>
                <div class="category-card" onclick="filterByCategory('data-science')">
                    <div class="category-icon">üìä</div>
                    <h3>Data Science</h3>
                    <p>Python, R, Jupyter, and analytics tools</p>
                    <div class="category-count" id="data-science-count">-</div>
                </div>
                <div class="category-card" onclick="filterByCategory('devops')">
                    <div class="category-icon">‚öôÔ∏è</div>
                    <h3>DevOps</h3>
                    <p>Infrastructure, containerization, and deployment tools</p>
                    <div class="category-count" id="devops-count">-</div>
                </div>
                <div class="category-card" onclick="filterByCategory('mobile-dev')">
                    <div class="category-icon">üì±</div>
                    <h3>Mobile Development</h3>
                    <p>iOS, Android, React Native, and Flutter</p>
                    <div class="category-count" id="mobile-dev-count">-</div>
                </div>
                <div class="category-card" onclick="filterByCategory('backend')">
                    <div class="category-icon">üîß</div>
                    <h3>Backend Development</h3>
                    <p>Server-side frameworks and databases</p>
                    <div class="category-count" id="backend-count">-</div>
                </div>
                <div class="category-card" onclick="filterByCategory('minimal')">
                    <div class="category-icon">‚ú®</div>
                    <h3>Minimal Setups</h3>
                    <p>Essential tools for any developer</p>
                    <div class="category-count" id="minimal-count">-</div>
                </div>
            </div>
        </div>

        <!-- Templates Grid -->
        <div class="templates-section">
            <div class="section-header">
                <h2 id="templates-section-title">All Templates</h2>
                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="setView('grid')" id="grid-view">
                        <span>‚äû</span> Grid
                    </button>
                    <button class="toggle-btn" onclick="setView('list')" id="list-view">
                        <span>‚ò∞</span> List
                    </button>
                </div>
            </div>

            <div id="templates-container" class="templates-grid">
                <div class="loading">Loading templates...</div>
            </div>

            <!-- Empty State -->
            <div id="templates-empty" class="empty" style="display: none;">
                <div class="empty-icon">üì¶</div>
                <h3>No templates found</h3>
                <p>Try adjusting your search criteria or browse our popular categories above.</p>
                <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>

        <!-- Create Template CTA -->
        <div class="create-template-cta">
            <div class="cta-content">
                <h2>Share Your Configuration</h2>
                <p>Have a great development setup? Share it with the community and help other developers get productive faster.</p>
                <div class="cta-buttons">
                    <a href="/#create-template" class="btn btn-primary">Create Template</a>
                    <a href="/docs#templates" class="btn btn-secondary">Learn More</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Detail Modal -->
    <div id="template-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Template Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Template details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" id="modal-download" onclick="downloadCurrentTemplate()">
                    Download Template
                </button>
            </div>
        </div>
    </div>
    <div id="modal-overlay" class="modal-overlay" onclick="closeModal()" style="display: none;"></div>

    <script>
        let allTemplates = [];
        let currentView = 'grid';
        let currentTemplate = null;
        let currentUser = null;
        let templateRatings = new Map();

        // Load templates on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadTemplates();
            loadTemplateStats();
            setupEventListeners();
        });

        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/user');
                if (response.ok) {
                    currentUser = await response.json();
                    showLoggedInState();
                } else {
                    const data = await response.json();
                    if (data.configured === false) {
                        showAuthNotConfigured();
                    } else {
                        showLoggedOutState();
                    }
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
                showLoggedOutState();
            }
        }

        function showLoggedInState() {
            document.getElementById('auth-loading').style.display = 'none';
            document.getElementById('auth-logged-out').style.display = 'none';
            document.getElementById('auth-not-configured').style.display = 'none';
            document.getElementById('auth-logged-in').style.display = 'block';

            document.getElementById('user-avatar').src = currentUser.avatar_url;
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-profile-link').href = `/users/${currentUser.username}`;
        }

        function showLoggedOutState() {
            document.getElementById('auth-loading').style.display = 'none';
            document.getElementById('auth-logged-in').style.display = 'none';
            document.getElementById('auth-not-configured').style.display = 'none';
            document.getElementById('auth-logged-out').style.display = 'block';
        }

        function showAuthNotConfigured() {
            document.getElementById('auth-loading').style.display = 'none';
            document.getElementById('auth-logged-in').style.display = 'none';
            document.getElementById('auth-logged-out').style.display = 'none';
            document.getElementById('auth-not-configured').style.display = 'block';
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('template-search').addEventListener('input', filterTemplates);
            document.getElementById('template-tags').addEventListener('input', filterTemplates);
            document.getElementById('template-featured').addEventListener('change', filterTemplates);
            document.getElementById('template-sort').addEventListener('change', sortAndDisplayTemplates);
        }

        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();
                allTemplates = data.templates || [];

                // Load ratings for all templates
                await Promise.all(allTemplates.map(async (template) => {
                    try {
                        const ratingResponse = await fetch(`/api/templates/${template.id}/rating`);
                        if (ratingResponse.ok) {
                            const rating = await ratingResponse.json();
                            templateRatings.set(template.id, rating);
                        }
                    } catch (error) {
                        console.error(`Failed to load rating for template ${template.id}:`, error);
                    }
                }));

                sortAndDisplayTemplates();
                updateCategoryCounts();
            } catch (error) {
                console.error('Failed to load templates:', error);
                document.getElementById('templates-container').innerHTML =
                    '<div class="error">Failed to load templates. Please try again later.</div>';
            }
        }

        async function loadTemplateStats() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();
                const templates = data.templates || [];

                const total = templates.length;
                const featured = templates.filter(t => t.featured).length;
                const totalDownloads = templates.reduce((sum, t) => sum + (t.downloads || 0), 0);

                document.getElementById('total-templates').textContent = total;
                document.getElementById('featured-templates').textContent = featured;
                document.getElementById('total-template-downloads').textContent = totalDownloads.toLocaleString();
            } catch (error) {
                console.error('Failed to load template stats:', error);
            }
        }

        function filterTemplates() {
            const search = document.getElementById('template-search').value.toLowerCase();
            const tags = document.getElementById('template-tags').value.toLowerCase();
            const featured = document.getElementById('template-featured').value;

            let filtered = allTemplates.filter(template => {
                // Search filter
                if (search) {
                    const searchText = (template.name + ' ' + template.description + ' ' +
                                     (template.tags || []).join(' ')).toLowerCase();
                    if (!searchText.includes(search)) return false;
                }

                // Tags filter
                if (tags) {
                    const tagsList = tags.split(',').map(t => t.trim());
                    const templateTags = (template.tags || []).map(t => t.toLowerCase());
                    if (!tagsList.some(tag => templateTags.some(tTag => tTag.includes(tag)))) {
                        return false;
                    }
                }

                // Featured filter
                if (featured === 'true' && !template.featured) return false;
                if (featured === 'false' && template.featured) return false;

                return true;
            });

            displayTemplates(filtered);
            updateSectionTitle(filtered.length);
        }

        function sortAndDisplayTemplates() {
            const sortBy = document.getElementById('template-sort').value;
            let sorted = [...allTemplates];

            switch (sortBy) {
                case 'downloads':
                    sorted.sort((a, b) => (b.downloads || 0) - (a.downloads || 0));
                    break;
                case 'name':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'updated':
                    sorted.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                    break;
                case 'author':
                    sorted.sort((a, b) => a.author.localeCompare(b.author));
                    break;
            }

            allTemplates = sorted;
            filterTemplates();
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templates-container');
            const emptyState = document.getElementById('templates-empty');

            if (templates.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = currentView === 'grid' ? 'grid' : 'block';
            container.className = currentView === 'grid' ? 'templates-grid' : 'templates-list';
            emptyState.style.display = 'none';

            container.innerHTML = templates.map(template => createTemplateCard(template)).join('');
        }

        function createTemplateCard(template) {
            const isListView = currentView === 'list';
            const cardClass = isListView ? 'template-card list-view' : 'template-card';
            const rating = templateRatings.get(template.id);
            const isFavorited = currentUser && currentUser.favorites && currentUser.favorites.includes(template.id);

            return `
                <div class="${cardClass}" onclick="showTemplateDetail('${template.id}')">
                    <div class="template-header">
                        <div class="template-title-row">
                            <h3>${template.name}${template.featured ? '<span class="featured-badge">Featured</span>' : ''}</h3>
                            ${rating && rating.total_ratings > 0 ? `
                            <div class="template-rating">
                                <div class="stars">${generateStars(rating.average_rating)}</div>
                                <span class="rating-text">(${rating.total_ratings})</span>
                            </div>` : ''}
                        </div>
                        <div class="author">by ${template.author}</div>
                        <div class="description">${template.description || 'No description provided'}</div>
                    </div>
                    ${template.tags && template.tags.length ? `
                    <div class="template-tags">
                        ${template.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>` : ''}
                    <div class="template-packages">
                        ${(template.brews && template.brews.length) ? `
                        <div class="package-group">
                            <strong>üç∫ Brews (${template.brews.length})</strong>
                            <div class="package-list">${template.brews.slice(0, 10).join(', ')}${template.brews.length > 10 ? '...' : ''}</div>
                        </div>` : ''}
                        ${(template.casks && template.casks.length) ? `
                        <div class="package-group">
                            <strong>üì¶ Casks (${template.casks.length})</strong>
                            <div class="package-list">${template.casks.slice(0, 10).join(', ')}${template.casks.length > 10 ? '...' : ''}</div>
                        </div>` : ''}
                        ${(!template.brews?.length && !template.casks?.length) ? '<div class="package-list">No packages defined</div>' : ''}
                    </div>
                    <div class="template-footer">
                        <span>${(template.downloads || 0).toLocaleString()} downloads ‚Ä¢ ${new Date(template.updated_at).toLocaleDateString()}</span>
                        <div class="template-actions">
                            ${currentUser ? `
                            <button class="favorite-btn ${isFavorited ? 'favorited' : ''}"
                                    onclick="event.stopPropagation(); toggleFavorite('${template.id}')"
                                    title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}">
                                ${isFavorited ? '‚ù§Ô∏è' : 'ü§ç'}
                            </button>` : ''}
                            <button class="download-btn" onclick="event.stopPropagation(); downloadTemplate('${template.id}')">
                                Download
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            return '‚òÖ'.repeat(fullStars) +
                   (hasHalfStar ? '‚òÜ' : '') +
                   '‚òÜ'.repeat(emptyStars);
        }

        function updateCategoryCounts() {
            const categories = {
                'web-dev': 0,
                'data-science': 0,
                'devops': 0,
                'mobile-dev': 0,
                'backend': 0,
                'minimal': 0
            };

            allTemplates.forEach(template => {
                if (template.tags) {
                    template.tags.forEach(tag => {
                        const normalizedTag = tag.toLowerCase();
                        if (normalizedTag.includes('web') || normalizedTag.includes('frontend') || normalizedTag.includes('javascript')) {
                            categories['web-dev']++;
                        }
                        if (normalizedTag.includes('data') || normalizedTag.includes('science') || normalizedTag.includes('python') || normalizedTag.includes('r')) {
                            categories['data-science']++;
                        }
                        if (normalizedTag.includes('devops') || normalizedTag.includes('docker') || normalizedTag.includes('kubernetes')) {
                            categories['devops']++;
                        }
                        if (normalizedTag.includes('mobile') || normalizedTag.includes('ios') || normalizedTag.includes('android')) {
                            categories['mobile-dev']++;
                        }
                        if (normalizedTag.includes('backend') || normalizedTag.includes('server') || normalizedTag.includes('api')) {
                            categories['backend']++;
                        }
                        if (normalizedTag.includes('minimal') || normalizedTag.includes('essential')) {
                            categories['minimal']++;
                        }
                    });
                }
            });

            Object.keys(categories).forEach(category => {
                const element = document.getElementById(category + '-count');
                if (element) {
                    element.textContent = categories[category];
                }
            });
        }

        function filterByCategory(category) {
            document.getElementById('template-tags').value = category;
            document.getElementById('templates-section-title').textContent =
                category.charAt(0).toUpperCase() + category.slice(1).replace('-', ' ') + ' Templates';
            filterTemplates();

            // Scroll to templates section
            document.querySelector('.templates-section').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        function setView(view) {
            currentView = view;

            // Update button states
            document.getElementById('grid-view').classList.toggle('active', view === 'grid');
            document.getElementById('list-view').classList.toggle('active', view === 'list');

            // Re-render templates with new view
            filterTemplates();
        }

        function updateSectionTitle(count) {
            const title = document.getElementById('templates-section-title');
            const search = document.getElementById('template-search').value;
            const tags = document.getElementById('template-tags').value;

            if (search || tags) {
                title.textContent = `${count} Template${count !== 1 ? 's' : ''} Found`;
            } else {
                title.textContent = 'All Templates';
            }
        }

        function clearFilters() {
            document.getElementById('template-search').value = '';
            document.getElementById('template-tags').value = '';
            document.getElementById('template-featured').value = '';
            document.getElementById('templates-section-title').textContent = 'All Templates';
            filterTemplates();
        }

        async function showTemplateDetail(templateId) {
            try {
                const [templateResponse, reviewsResponse] = await Promise.all([
                    fetch(`/api/templates/${templateId}`),
                    fetch(`/api/templates/${templateId}/reviews`)
                ]);

                const template = await templateResponse.json();
                const reviewsData = await reviewsResponse.json();
                currentTemplate = { ...template, reviews: reviewsData.reviews || [] };

                document.getElementById('modal-title').textContent = template.metadata.name;
                document.getElementById('modal-body').innerHTML = generateTemplateDetailHTML(currentTemplate);
                document.getElementById('template-modal').style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'block';
            } catch (error) {
                console.error('Failed to load template details:', error);
                alert('Failed to load template details. Please try again.');
            }
        }

        function generateTemplateDetailHTML(template) {
            const rating = templateRatings.get(template.id);
            const reviews = template.reviews || [];
            const userReview = currentUser ? reviews.find(r => r.user_id === currentUser.id) : null;

            return `
                <div class="template-detail">
                    <div class="template-info">
                        <div class="template-meta">
                            <span class="meta-item"><strong>Author:</strong> ${template.metadata.author}</span>
                            <span class="meta-item"><strong>Version:</strong> ${template.metadata.version || '1.0.0'}</span>
                            <span class="meta-item"><strong>Updated:</strong> ${new Date(template.metadata.created_at).toLocaleDateString()}</span>
                            ${template.featured ? '<span class="featured-badge">Featured</span>' : ''}
                        </div>

                        ${rating && rating.total_ratings > 0 ? `
                        <div class="template-rating-detail">
                            <div class="rating-summary">
                                <div class="average-rating">
                                    <span class="rating-number">${rating.average_rating.toFixed(1)}</span>
                                    <div class="stars-large">${generateStars(rating.average_rating)}</div>
                                    <span class="rating-count">${rating.total_ratings} review${rating.total_ratings !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="rating-distribution">
                                    ${[5,4,3,2,1].map(star => `
                                        <div class="rating-bar">
                                            <span>${star}‚òÖ</span>
                                            <div class="bar">
                                                <div class="fill" style="width: ${rating.distribution[star] ? (rating.distribution[star] / rating.total_ratings * 100) : 0}%"></div>
                                            </div>
                                            <span>${rating.distribution[star] || 0}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>` : ''}

                        <p class="template-description">${template.metadata.description || 'No description provided'}</p>
                        ${template.metadata.tags && template.metadata.tags.length ? `
                        <div class="template-tags">
                            ${template.metadata.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>` : ''}
                    </div>

                    <div class="package-details">
                        <h3>Package Summary</h3>
                        ${template.brews && template.brews.length ? `
                        <div class="package-section">
                            <h4>üç∫ Homebrew Packages (${template.brews.length})</h4>
                            <div class="package-grid">${template.brews.map(pkg => `<span class="package-item">${pkg}</span>`).join('')}</div>
                        </div>` : ''}
                        ${template.casks && template.casks.length ? `
                        <div class="package-section">
                            <h4>üì¶ Applications (${template.casks.length})</h4>
                            <div class="package-grid">${template.casks.map(pkg => `<span class="package-item">${pkg}</span>`).join('')}</div>
                        </div>` : ''}
                        ${template.taps && template.taps.length ? `
                        <div class="package-section">
                            <h4>üìã Homebrew Taps (${template.taps.length})</h4>
                            <div class="package-grid">${template.taps.map(pkg => `<span class="package-item">${pkg}</span>`).join('')}</div>
                        </div>` : ''}
                        ${template.stow && template.stow.length ? `
                        <div class="package-section">
                            <h4>üîó Dotfile Configurations (${template.stow.length})</h4>
                            <div class="package-grid">${template.stow.map(pkg => `<span class="package-item">${pkg}</span>`).join('')}</div>
                        </div>` : ''}
                    </div>

                    <div class="usage-instructions">
                        <h3>Usage</h3>
                        <div class="code-block">
                            <code>dotfiles clone template:${template.metadata.name.toLowerCase().replace(/\s+/g, '-')}</code>
                            <button class="copy-btn" onclick="copyToClipboard('dotfiles clone template:${template.metadata.name.toLowerCase().replace(/\s+/g, '-')}')">Copy</button>
                        </div>
                    </div>

                    <div class="reviews-section">
                        <div class="reviews-header">
                            <h3>Reviews</h3>
                            ${currentUser && !userReview ? `
                            <button class="btn btn-primary" onclick="showReviewForm()">Write a Review</button>
                            ` : ''}
                        </div>

                        ${currentUser && !userReview ? `
                        <div class="review-form" id="review-form" style="display: none;">
                            <h4>Write a Review</h4>
                            <div class="rating-input">
                                <label>Rating:</label>
                                <div class="star-rating" id="star-rating">
                                    ${[1,2,3,4,5].map(star => `
                                        <span class="star" data-rating="${star}" onclick="setRating(${star})">‚òÜ</span>
                                    `).join('')}
                                </div>
                            </div>
                            <textarea id="review-comment" placeholder="Share your experience with this template..." rows="4"></textarea>
                            <div class="form-actions">
                                <button class="btn btn-secondary" onclick="hideReviewForm()">Cancel</button>
                                <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
                            </div>
                        </div>` : ''}

                        <div class="reviews-list">
                            ${reviews.length > 0 ? reviews.map(review => `
                                <div class="review-item">
                                    <div class="review-header">
                                        <img src="${review.avatar_url}" alt="${review.username}" class="review-avatar">
                                        <div class="review-info">
                                            <strong>${review.username}</strong>
                                            <div class="review-rating">${generateStars(review.rating)}</div>
                                            <span class="review-date">${new Date(review.created_at).toLocaleDateString()}</span>
                                        </div>
                                        ${currentUser && review.user_id === currentUser.id ? `
                                        <div class="review-actions">
                                            <button class="btn-text" onclick="editReview('${review.id}')">Edit</button>
                                            <button class="btn-text" onclick="deleteReview('${review.id}')">Delete</button>
                                        </div>` : ''}
                                    </div>
                                    ${review.comment ? `<p class="review-comment">${review.comment}</p>` : ''}
                                    <div class="review-footer">
                                        <button class="helpful-btn" onclick="markHelpful('${review.id}')">
                                            üëç Helpful (${review.helpful || 0})
                                        </button>
                                    </div>
                                </div>
                            `).join('') : '<p class="no-reviews">No reviews yet. Be the first to review this template!</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('template-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
            currentTemplate = null;
        }

        async function downloadTemplate(templateId) {
            try {
                const response = await fetch(`/api/templates/${templateId}/download`);
                const template = await response.json();

                const dataStr = JSON.stringify(template, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${template.metadata.name.toLowerCase().replace(/\s+/g, '-')}-template.json`;
                link.click();

                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download template:', error);
                alert('Failed to download template. Please try again.');
            }
        }

        function downloadCurrentTemplate() {
            if (currentTemplate) {
                downloadTemplate(currentTemplate.id || Object.keys(currentTemplate)[0]);
            }
        }

        // Favorites functionality
        async function toggleFavorite(templateId) {
            if (!currentUser) {
                alert('Please sign in to add favorites');
                return;
            }

            const isFavorited = currentUser.favorites && currentUser.favorites.includes(templateId);
            const method = isFavorited ? 'DELETE' : 'POST';
            const url = `/api/users/favorites/${templateId}`;

            try {
                const response = await fetch(url, { method });
                if (response.ok) {
                    // Update local state
                    if (isFavorited) {
                        currentUser.favorites = currentUser.favorites.filter(id => id !== templateId);
                    } else {
                        if (!currentUser.favorites) currentUser.favorites = [];
                        currentUser.favorites.push(templateId);
                    }
                    // Re-render templates to update UI
                    filterTemplates();
                } else {
                    throw new Error('Failed to update favorite');
                }
            } catch (error) {
                console.error('Failed to toggle favorite:', error);
                alert('Failed to update favorite. Please try again.');
            }
        }

        async function showFavorites() {
            if (!currentUser) {
                alert('Please sign in to view favorites');
                return;
            }

            document.getElementById('template-search').value = '';
            document.getElementById('template-tags').value = '';
            document.getElementById('template-featured').value = '';

            const favoriteTemplates = allTemplates.filter(template =>
                currentUser.favorites && currentUser.favorites.includes(template.id)
            );

            displayTemplates(favoriteTemplates);
            document.getElementById('templates-section-title').textContent = 'Your Favorites';
        }

        // Review functionality
        let selectedRating = 0;

        function showReviewForm() {
            document.getElementById('review-form').style.display = 'block';
        }

        function hideReviewForm() {
            document.getElementById('review-form').style.display = 'none';
            selectedRating = 0;
            document.getElementById('review-comment').value = '';
            updateStarDisplay();
        }

        function setRating(rating) {
            selectedRating = rating;
            updateStarDisplay();
        }

        function updateStarDisplay() {
            const stars = document.querySelectorAll('#star-rating .star');
            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.textContent = '‚òÖ';
                    star.classList.add('selected');
                } else {
                    star.textContent = '‚òÜ';
                    star.classList.remove('selected');
                }
            });
        }

        async function submitReview() {
            if (!selectedRating) {
                alert('Please select a rating');
                return;
            }

            const comment = document.getElementById('review-comment').value.trim();

            try {
                const response = await fetch(`/api/templates/${currentTemplate.id}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rating: selectedRating,
                        comment: comment
                    })
                });

                if (response.ok) {
                    hideReviewForm();
                    // Refresh the modal content
                    showTemplateDetail(currentTemplate.id);
                    // Refresh the template rating in the main list
                    const ratingResponse = await fetch(`/api/templates/${currentTemplate.id}/rating`);
                    if (ratingResponse.ok) {
                        const rating = await ratingResponse.json();
                        templateRatings.set(currentTemplate.id, rating);
                    }
                    filterTemplates(); // Re-render to show updated rating
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to submit review');
                }
            } catch (error) {
                console.error('Failed to submit review:', error);
                alert('Failed to submit review. Please try again.');
            }
        }

        async function markHelpful(reviewId) {
            try {
                const response = await fetch(`/api/reviews/${reviewId}/helpful`, {
                    method: 'POST'
                });

                if (response.ok) {
                    // Refresh the modal content to show updated helpful count
                    showTemplateDetail(currentTemplate.id);
                } else {
                    console.error('Failed to mark review as helpful');
                }
            } catch (error) {
                console.error('Failed to mark review as helpful:', error);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show feedback
                event.target.textContent = '‚úì Copied!';
                setTimeout(() => {
                    event.target.textContent = 'Copy';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text:', err);
            });
        }
    </script>
</body>
</html>