<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Dotfiles Manager</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/universal-header.css">
</head>
<body>
    <!-- Universal Header -->
    <header class="universal-header">
        <div class="header-container">
            <a href="/" class="header-brand">
                Dotfiles Manager
            </a>
            <nav class="header-nav">
                <a href="/">Home</a>
                <a href="/templates">Templates</a>
                <a href="/docs">Documentation</a>
            </nav>
            <div class="header-attribution">
                <div class="auth-section" id="auth-section">
                    <div class="auth-loading" id="auth-loading">Loading...</div>
                    <div class="auth-logged-out" id="auth-logged-out" style="display: none;">
                        <a href="/auth/github" class="btn btn-primary btn-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Sign in with GitHub
                        </a>
                    </div>
                    <div class="auth-not-configured" id="auth-not-configured" style="display: none;">
                        <span class="auth-message">Authentication not configured</span>
                    </div>
                    <div class="auth-logged-in" id="auth-logged-in" style="display: none;">
                        <div class="user-menu">
                            <img id="user-avatar" class="user-avatar" src="" alt="">
                            <span id="user-name"></span>
                            <div class="user-dropdown">
                                <a href="#" id="user-profile-link">Profile</a>
                                <a href="#" onclick="showFavorites()">Favorites</a>
                                <a href="/auth/logout">Sign out</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="attribution-links">
                    <span>Created by Wyat Soule</span>
                    <a href="https://github.com/wsoule" target="_blank">GitHub</a>
                    <a href="https://github.com/wsoule/go-dotfiles" target="_blank">Repository</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Profile Header -->
        <div class="profile-header" id="profile-header">
            <div class="loading">Loading profile...</div>
        </div>

        <!-- Profile Navigation -->
        <div class="profile-nav" id="profile-nav" style="display: none;">
            <button class="nav-btn active" onclick="showSection('overview')" id="overview-btn">Overview</button>
            <button class="nav-btn" onclick="showSection('templates')" id="templates-btn">Templates</button>
            <button class="nav-btn" onclick="showSection('reviews')" id="reviews-btn">Reviews</button>
            <button class="nav-btn" onclick="showSection('favorites')" id="favorites-btn">Favorites</button>
            <button class="nav-btn" onclick="showSection('organizations')" id="organizations-btn">Organizations</button>
        </div>

        <!-- Profile Content -->
        <div class="profile-content" id="profile-content">

            <!-- Overview Section -->
            <div class="profile-section" id="overview-section">
                <div class="stats-grid" id="user-stats">
                    <!-- Stats will be loaded here -->
                </div>

                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div id="recent-activity-list">
                        <!-- Recent activity will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Templates Section -->
            <div class="profile-section" id="templates-section" style="display: none;">
                <div class="section-header">
                    <h2>My Templates</h2>
                    <button class="btn btn-primary" onclick="showCreateTemplate()">Create Template</button>
                </div>
                <div id="user-templates" class="templates-grid">
                    <!-- User templates will be loaded here -->
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="profile-section" id="reviews-section" style="display: none;">
                <div class="section-header">
                    <h2>My Reviews</h2>
                </div>
                <div id="user-reviews" class="reviews-list">
                    <!-- User reviews will be loaded here -->
                </div>
            </div>

            <!-- Favorites Section -->
            <div class="profile-section" id="favorites-section" style="display: none;">
                <div class="section-header">
                    <h2>Favorite Templates</h2>
                </div>
                <div id="user-favorites" class="templates-grid">
                    <!-- User favorites will be loaded here -->
                </div>
            </div>

            <!-- Organizations Section -->
            <div class="profile-section" id="organizations-section" style="display: none;">
                <div class="section-header">
                    <h2>Organizations</h2>
                    <button class="btn btn-primary" onclick="showCreateOrganization()">Create Organization</button>
                </div>

                <div class="organizations-grid" id="user-organizations">
                    <!-- User organizations will be loaded here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Create Organization Modal -->
    <div id="create-org-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Organization</h2>
                <button class="modal-close" onclick="closeCreateOrgModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-org-form">
                    <div class="form-group">
                        <label for="org-name">Organization Name</label>
                        <input type="text" id="org-name" name="name" required placeholder="e.g., Acme Corp">
                    </div>
                    <div class="form-group">
                        <label for="org-slug">URL Slug</label>
                        <input type="text" id="org-slug" name="slug" required placeholder="e.g., acme-corp">
                        <small>Used in URLs: /orgs/acme-corp</small>
                    </div>
                    <div class="form-group">
                        <label for="org-description">Description</label>
                        <textarea id="org-description" name="description" rows="3" placeholder="Describe your organization..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="org-website">Website (Optional)</label>
                        <input type="url" id="org-website" name="website" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="org-public" name="public" checked>
                            Public Organization
                        </label>
                        <small>Public organizations are discoverable by all users</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateOrgModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createOrganization()">Create Organization</button>
            </div>
        </div>
    </div>
    <div id="create-org-overlay" class="modal-overlay" onclick="closeCreateOrgModal()" style="display: none;"></div>

    <script>
        let currentUser = null;
        let profileUser = null;
        let currentSection = 'overview';

        // Get username from URL path
        const username = window.location.pathname.split('/').pop();

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadUserProfile();
        });

        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/user');
                if (response.ok) {
                    currentUser = await response.json();
                    showLoggedInState();
                } else {
                    const data = await response.json();
                    if (data.configured === false) {
                        showAuthNotConfigured();
                    } else {
                        showLoggedOutState();
                    }
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
                showLoggedOutState();
            }
        }

        function showLoggedInState() {
            document.getElementById('auth-loading').style.display = 'none';
            document.getElementById('auth-logged-out').style.display = 'none';
            document.getElementById('auth-not-configured').style.display = 'none';
            document.getElementById('auth-logged-in').style.display = 'block';

            document.getElementById('user-avatar').src = currentUser.avatar_url;
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-profile-link').href = `/profile/${currentUser.username}`;
        }

        function showLoggedOutState() {
            document.getElementById('auth-loading').style.display = 'none';
            document.getElementById('auth-logged-in').style.display = 'none';
            document.getElementById('auth-not-configured').style.display = 'none';
            document.getElementById('auth-logged-out').style.display = 'block';
        }

        function showAuthNotConfigured() {
            document.getElementById('auth-loading').style.display = 'none';
            document.getElementById('auth-logged-in').style.display = 'none';
            document.getElementById('auth-logged-out').style.display = 'none';
            document.getElementById('auth-not-configured').style.display = 'block';
        }

        // Profile functions
        async function loadUserProfile() {
            try {
                const response = await fetch(`/api/users/${username}`);
                if (response.ok) {
                    const data = await response.json();
                    profileUser = data.user;
                    displayUserProfile(data);
                } else {
                    document.getElementById('profile-header').innerHTML =
                        '<div class="error">User not found</div>';
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
                document.getElementById('profile-header').innerHTML =
                    '<div class="error">Failed to load profile</div>';
            }
        }

        function displayUserProfile(data) {
            const { user, reviews, favoriteTemplates } = data;

            // Update page title
            document.title = `${user.username} - Dotfiles Manager`;

            // Display profile header
            document.getElementById('profile-header').innerHTML = `
                <div class="profile-info">
                    <img src="${user.avatar_url}" alt="${user.username}" class="profile-avatar">
                    <div class="profile-details">
                        <h1>${user.name || user.username}</h1>
                        <p class="username">@${user.username}</p>
                        ${user.bio ? `<p class="bio">${user.bio}</p>` : ''}
                        <div class="profile-meta">
                            ${user.location ? `<span class="meta-item">📍 ${user.location}</span>` : ''}
                            ${user.website ? `<a href="${user.website}" target="_blank" class="meta-item">🔗 Website</a>` : ''}
                            <span class="meta-item">📅 Joined ${new Date(user.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `;

            // Show navigation
            document.getElementById('profile-nav').style.display = 'flex';

            // Load initial section data
            loadOverviewData(data);
        }

        function loadOverviewData(data) {
            const { user, reviews, favoriteTemplates } = data;

            // Display user stats
            document.getElementById('user-stats').innerHTML = `
                <div class="stat-card">
                    <h3>Templates</h3>
                    <div class="number">0</div>
                </div>
                <div class="stat-card">
                    <h3>Reviews</h3>
                    <div class="number">${reviews ? reviews.length : 0}</div>
                </div>
                <div class="stat-card">
                    <h3>Favorites</h3>
                    <div class="number">${favoriteTemplates ? favoriteTemplates.length : 0}</div>
                </div>
                <div class="stat-card">
                    <h3>Organizations</h3>
                    <div class="number">0</div>
                </div>
            `;

            // Display recent activity
            const recentActivity = [];
            if (reviews) {
                reviews.slice(0, 5).forEach(review => {
                    recentActivity.push({
                        type: 'review',
                        date: review.created_at,
                        content: `Reviewed a template with ${review.rating} stars`,
                        link: `/templates#${review.template_id}`
                    });
                });
            }

            document.getElementById('recent-activity-list').innerHTML = recentActivity.length > 0
                ? recentActivity.map(activity => `
                    <div class="activity-item">
                        <span class="activity-type">${activity.type}</span>
                        <span class="activity-content">${activity.content}</span>
                        <span class="activity-date">${new Date(activity.date).toLocaleDateString()}</span>
                    </div>
                `).join('')
                : '<p class="no-activity">No recent activity</p>';
        }

        function showSection(section) {
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(section + '-btn').classList.add('active');

            // Hide all sections
            document.querySelectorAll('.profile-section').forEach(sec => sec.style.display = 'none');

            // Show selected section
            document.getElementById(section + '-section').style.display = 'block';
            currentSection = section;

            // Load section data if needed
            if (section === 'templates') {
                loadUserTemplates();
            } else if (section === 'reviews') {
                loadUserReviews();
            } else if (section === 'favorites') {
                loadUserFavorites();
            } else if (section === 'organizations') {
                loadUserOrganizations();
            }
        }

        async function loadUserTemplates() {
            // TODO: Implement user templates loading
            document.getElementById('user-templates').innerHTML =
                '<p class="empty-state">No templates created yet</p>';
        }

        async function loadUserReviews() {
            // TODO: Implement user reviews loading
            document.getElementById('user-reviews').innerHTML =
                '<p class="empty-state">No reviews yet</p>';
        }

        async function loadUserFavorites() {
            // TODO: Implement user favorites loading
            document.getElementById('user-favorites').innerHTML =
                '<p class="empty-state">No favorites yet</p>';
        }

        async function loadUserOrganizations() {
            try {
                // Get user's organization memberships using the new API endpoint
                const response = await fetch(`/api/users/${profileUser.username}/organizations`);
                if (!response.ok) {
                    throw new Error('Failed to load organizations');
                }

                const data = await response.json();
                const userOrganizations = data.organizations || [];

                if (userOrganizations.length === 0) {
                    document.getElementById('user-organizations').innerHTML =
                        '<p class="empty-state">No organizations yet</p>';
                    return;
                }

                // Display organizations
                document.getElementById('user-organizations').innerHTML = userOrganizations.map(org => `
                    <div class="organization-card">
                        <div class="org-header">
                            <h3>${org.name}</h3>
                            <span class="org-visibility ${org.public ? 'public' : 'private'}">
                                ${org.public ? 'Public' : 'Private'}
                            </span>
                        </div>
                        <p class="org-description">${org.description || 'No description'}</p>
                        <div class="org-meta">
                            <span class="member-count">${org.member_count || 0} members</span>
                            <span class="created-date">Created ${new Date(org.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="org-actions">
                            <a href="/organizations/${org.slug}" class="btn btn-sm btn-secondary">View</a>
                            ${profileUser.id === currentUser?.id ? `
                                <button class="btn btn-sm btn-primary" onclick="editOrganization('${org.id}')">Edit</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load user organizations:', error);
                document.getElementById('user-organizations').innerHTML =
                    '<p class="empty-state error">Failed to load organizations</p>';
            }
        }

        // Organization functions
        function showCreateOrganization() {
            if (!currentUser) {
                alert('Please sign in to create an organization');
                return;
            }
            document.getElementById('create-org-modal').style.display = 'block';
            document.getElementById('create-org-overlay').style.display = 'block';
        }

        function closeCreateOrgModal() {
            document.getElementById('create-org-modal').style.display = 'none';
            document.getElementById('create-org-overlay').style.display = 'none';
            document.getElementById('create-org-form').reset();
        }

        function createOrganization() {
            // TODO: Implement organization creation
            alert('Organization creation will be implemented');
            closeCreateOrgModal();
        }

        // Auto-generate slug from name
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('org-name');
            const slugInput = document.getElementById('org-slug');

            if (nameInput && slugInput) {
                nameInput.addEventListener('input', function() {
                    const slug = this.value.toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '');
                    slugInput.value = slug;
                });
            }
        });

        function showCreateTemplate() {
            alert('Template creation will be implemented');
        }

        function showFavorites() {
            window.location.href = '/templates?favorites=true';
        }
    </script>
</body>
</html>